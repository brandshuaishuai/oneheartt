!function(s){"use strict";var t=s.editors.TextEditor.prototype.extend();t.prototype.prepare=function(t,e,i,o,a,n){s.editors.TextEditor.prototype.prepare.apply(this,arguments),this.options={},this.cellProperties.chosenOptions&&(this.options=$.extend(this.options,n.chosenOptions)),n.chosenOptions=$.extend({},n.chosenOptions)},t.prototype.createElements=function(){this.$body=$(document.body),this.TEXTAREA=document.createElement("select"),this.TEXTAREA.select=function(){},this.$textarea=$(this.TEXTAREA),s.dom.addClass(this.TEXTAREA,"handsontableInput"),this.textareaStyle=this.TEXTAREA.style,this.textareaStyle.width=0,this.textareaStyle.height=0,this.TEXTAREA_PARENT=document.createElement("DIV"),s.dom.addClass(this.TEXTAREA_PARENT,"handsontableInputHolder"),this.textareaParentStyle=this.TEXTAREA_PARENT.style,this.textareaParentStyle.top=0,this.textareaParentStyle.left=0,this.textareaParentStyle.display="none",this.textareaParentStyle.width="200px",this.TEXTAREA_PARENT.appendChild(this.TEXTAREA),this.instance.rootElement.appendChild(this.TEXTAREA_PARENT);var t=this;this.instance._registerTimeout(setTimeout(function(){t.refreshDimensions()},0))};var r=function(t){var e=this.getActiveEditor(),i=s.helper.KEY_CODES,o=(t.ctrlKey||t.metaKey)&&!t.altKey;if("INPUT"===t.target.tagName)if(17!==t.keyCode&&224!==t.keyCode&&91!==t.keyCode&&93!==t.keyCode){var a=t.target;switch(t.keyCode){case i.ARROW_RIGHT:s.dom.getCaretPosition(a)!==a.value.length?t.stopImmediatePropagation():e.$textarea.trigger("chosen:close");break;case i.ARROW_LEFT:0!==s.dom.getCaretPosition(a)?t.stopImmediatePropagation():e.$textarea.trigger("chosen:close");break;case i.ENTER:e.cellProperties.chosenOptions.multiple&&(t.stopImmediatePropagation(),t.preventDefault(),t.stopPropagation());break;case i.A:case i.X:case i.C:case i.V:o&&t.stopImmediatePropagation();break;case i.BACKSPACE:var n=$(e.TEXTAREA_PARENT).find("input").val();$(e.TEXTAREA_PARENT).find("input").val(n.substr(0,n.length-1)).trigger("keyup.chosen"),t.stopImmediatePropagation();break;case i.DELETE:case i.HOME:case i.END:t.stopImmediatePropagation()}}else t.stopImmediatePropagation()};t.prototype.open=function(i){this.refreshDimensions(),this.textareaParentStyle.display="block",this.instance.addHook("beforeKeyDown",r),this.$textarea.css({height:$(this.TD).height()+4,"min-width":$(this.TD).outerWidth()-4}),this.$textarea.hide();var t=$.extend({},this.options,{width:"100%",search_contains:!0});t.multiple?this.$textarea.attr("multiple",!0):this.$textarea.attr("multiple",!1),this.$textarea.empty(),this.$textarea.append("<option value=''></option>");var e=null,o=(this.originalValue+"").split(",");if(t.data&&t.data.length)for(var a=0;a<t.data.length;a++)(e=$("<option />")).attr("value",t.data[a].id),e.html(t.data[a].label),-1<o.indexOf(t.data[a].id+"")&&e.attr("selected",!0),this.$textarea.append(e);$(this.TEXTAREA_PARENT).find(".chosen-container").length&&this.$textarea.chosen("destroy"),this.$textarea.chosen(t);var n=this;setTimeout(function(){n.$textarea.on("change",function(){this.cellProperties.chosenOptions.multiple||(this.close(),this.finishEditing())}.bind(n)),n.$textarea.on("chosen:hiding_dropdown",function(){this.cellProperties.chosenOptions.multiple||(this.close(),this.finishEditing())}.bind(n)),n.$textarea.trigger("chosen:open"),$(n.TEXTAREA_PARENT).find("input").on("keydown",function(t){if(t.keyCode===s.helper.KEY_CODES.ENTER&&($(this).val()?(t.preventDefault(),t.stopPropagation()):(t.preventDefault(),t.stopPropagation(),n.close(),n.finishEditing())),t.keyCode===s.helper.KEY_CODES.BACKSPACE){var e=$(n.TEXTAREA_PARENT).find("input").val();$(n.TEXTAREA_PARENT).find("input").val(e.substr(0,e.length-1)).trigger("keyup.chosen"),t.preventDefault(),t.stopPropagation()}t.keyCode!==s.helper.KEY_CODES.ARROW_DOWN&&t.keyCode!==s.helper.KEY_CODES.ARROW_UP||(t.preventDefault(),t.stopPropagation())}),setTimeout(function(){if(n.$textarea.trigger("chosen:activate").focus(),i&&i.keyCode&&113!=i.keyCode){var t=i.keyCode,e=String.fromCharCode(96<=t&&t<=105?t-48:t).toLowerCase();$(n.TEXTAREA_PARENT).find("input").val(e).trigger("keyup.chosen"),n.$textarea.trigger("chosen:activate")}},1)},1)},t.prototype.init=function(){s.editors.TextEditor.prototype.init.apply(this,arguments)},t.prototype.close=function(){this.instance.listen(),this.instance.removeHook("beforeKeyDown",r),this.$textarea.off(),this.$textarea.hide(),s.editors.TextEditor.prototype.close.apply(this,arguments)},t.prototype.getValue=function(){return this.$textarea.val()?"object"==typeof this.$textarea.val()?this.$textarea.val().join(","):this.$textarea.val():""},t.prototype.focus=function(){this.instance.listen()},t.prototype.beginEditing=function(t){var e=this.instance.getSettings().onBeginEditing;e&&!1===e()||s.editors.TextEditor.prototype.beginEditing.apply(this,arguments)},t.prototype.finishEditing=function(t,e){return this.instance.listen(),s.editors.TextEditor.prototype.finishEditing.apply(this,arguments)},s.editors.ChosenEditor=t,s.editors.registerEditor("chosen",t)}(Handsontable);